<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src * data:; connect-src *;">
    <title>NBA Pro Analytics</title>
    <style>
        :root { --bg: #121212; --card: #1e1e1e; --accent: #C9082A; --blue: #17408B; --text: #e0e0e0; --gold: #FDB927; }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); }
        
        header { padding: 0 30px; background: var(--card); border-bottom: 3px solid var(--accent); display: flex; justify-content: space-between; align-items: center; height: 70px; position: sticky; top: 0; z-index: 99; }
        .logo { font-weight: 900; font-size: 1.5rem; color: #fff; } .logo span { color: var(--accent); }
        nav { display: flex; gap: 15px; height: 100%; align-items: center; }
        nav button { background: none; border: none; color: #aaa; font-weight: 700; padding: 0 10px; cursor: pointer; text-transform: uppercase; height: 100%; border-bottom: 3px solid transparent; transition: 0.3s; font-size: 0.9rem; }
        nav button:hover, nav button.active { color: #fff; border-bottom-color: var(--accent); }
        .lang-btn { background: #333; color: #fff; border: 1px solid #555; padding: 6px 15px; border-radius: 20px; cursor: pointer; font-weight: bold; font-size: 0.8rem; }

        main { max-width: 1200px; margin: 0 auto; padding: 20px; min-height: 80vh; }
        .section { display: none; }
        .section.active { display: block; animation: fade 0.3s; }
        @keyframes fade { from{opacity:0} to{opacity:1} }

        /* UI Elements */
        .loader { text-align: center; padding: 50px; color: #666; font-style: italic; }
        .error-msg { text-align: center; padding: 20px; color: #ff6b6b; border: 1px solid #ff6b6b; border-radius: 8px; margin-top:10px; background: rgba(255,0,0,0.1); }
        
        /* News */
        .news-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .news-card { background: var(--card); border-radius: 8px; overflow: hidden; border: 1px solid #333; cursor: pointer; transition: 0.3s; }
        .news-card:hover { transform: translateY(-5px); border-color: var(--blue); }
        .news-img { width: 100%; height: 180px; object-fit: cover; }
        .news-body { padding: 15px; }
        .news-title { font-weight: bold; font-size: 1rem; color: #fff; margin-bottom: 5px; }

        /* Games */
        .date-picker { background: #252525; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: flex; gap: 10px; align-items: center; }
        .date-input { background: #111; color: #fff; border: 1px solid #444; padding: 10px; border-radius: 4px; color-scheme: dark; }
        .btn { background: var(--blue); color: #fff; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        
        .game-card { background: var(--card); border-radius: 10px; border: 1px solid #333; margin-bottom: 15px; overflow: hidden; }
        .game-main { display: flex; justify-content: space-between; align-items: center; padding: 20px; }
        .team { display: flex; flex-direction: column; align-items: center; width: 120px; }
        .team img { width: 60px; height: 60px; object-fit: contain; margin-bottom: 5px; }
        .score { font-size: 1.8rem; font-weight: bold; }
        .status { color: var(--accent); font-weight: bold; font-size: 0.9rem; }
        .game-footer { background: #252525; padding: 10px 20px; text-align: right; border-top: 1px solid #333; }
        .box-btn { background: transparent; border: 1px solid #555; color: #ccc; padding: 6px 15px; border-radius: 4px; cursor: pointer; font-size: 0.85rem; }
        .box-btn:hover { background: #fff; color: #000; }

        /* Modal */
        .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.9); z-index: 2000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-content { background: #1e1e1e; width: 95%; max-width: 1000px; max-height: 90vh; border-radius: 12px; overflow-y: auto; border: 1px solid #444; }
        .modal-header { padding: 15px 20px; background: #252525; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; }
        .modal-close { background: none; border: none; color: #fff; font-size: 1.5rem; cursor: pointer; }
        .bs-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.85rem; }
        .bs-table th { background: #111; color: #888; padding: 8px; text-align: center; position: sticky; top: 0; }
        .bs-table td { padding: 8px; border-bottom: 1px solid #333; text-align: center; color: #ddd; }
        .bs-table td:first-child { text-align: left; color: #fff; font-weight: bold; width: 150px; }

        /* Stats */
        .stats-table { width: 100%; border-collapse: collapse; margin-top: 20px; background: var(--card); border-radius: 8px; }
        .stats-table th { text-align: left; padding: 15px; background: #252525; color: #aaa; text-transform: uppercase; font-size: 0.8rem; }
        .stats-table td { padding: 15px; border-bottom: 1px solid #333; }
        .stat-val { float: right; font-weight: bold; color: var(--gold); font-size: 1.1rem; }
        .player-info { display: flex; align-items: center; gap: 10px; }
        .player-head { width: 40px; height: 40px; border-radius: 50%; background: #333; object-fit: cover; }
        
        .external-link { display: block; padding: 20px; background: #252525; text-align: center; border-radius: 8px; color: #fff; text-decoration: none; margin-top: 20px; font-weight: bold; border: 1px solid #444; transition: 0.3s; }
        .external-link:hover { background: var(--blue); border-color: var(--blue); }
    </style>
</head>
<body>

    <div id="modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title" style="margin:0">Box Score</h3>
                <button class="modal-close" id="close-modal">×</button>
            </div>
            <div id="modal-body" style="padding:20px;"></div>
        </div>
    </div>

    <header>
        <div class="logo">NBA <span>PRO</span></div>
        <nav>
            <button data-section="home" class="active nav-btn" id="nav-home">Haberler</button>
            <button data-section="games" class="nav-btn" id="nav-games">Maçlar</button>
            <button data-section="stats" class="nav-btn" id="nav-stats">İstatistikler</button>
            <button data-section="injuries" class="nav-btn" id="nav-injuries">Sakatlıklar</button>
            <button data-section="lineups" class="nav-btn" id="nav-lineups">Kadrolar</button>
        </nav>
        <button class="lang-btn" id="lang-toggle">EN / TR</button>
    </header>

    <main>
        <section id="home" class="section active">
            <h2 id="title-news" style="border-left: 4px solid var(--accent); padding-left: 10px; margin-bottom: 20px;">Latest News</h2>
            <div id="news-container" class="news-grid"></div>
        </section>

        <section id="games" class="section">
            <div class="date-picker">
                <input type="date" id="game-date" class="date-input">
                <button id="btn-refresh" class="btn">Get Data</button>
            </div>
            <div id="games-container"></div>
        </section>

        <section id="stats" class="section">
            <h2 id="title-stats">Season Leaders (PPG)</h2>
            <div id="stats-container"></div>
        </section>

        <section id="injuries" class="section">
            <h2 id="title-injuries">Injury Report</h2>
            <p id="desc-injuries" style="color:#aaa; text-align:center; margin-top:20px;">Official real-time data requires a paid license.</p>
            <a href="https://www.espn.com/nba/injuries" target="_blank" class="external-link" id="link-injuries-espn">View on ESPN &rarr;</a>
        </section>

        <section id="lineups" class="section">
            <h2 id="title-lineups">Starting Lineups</h2>
            <p id="desc-lineups" style="color:#aaa; text-align:center; margin-top:20px;">Updates 30 mins before tip-off.</p>
            <a href="https://www.rotowire.com/basketball/nba-lineups.php" target="_blank" class="external-link" id="link-lineups-roto">View on Rotowire &rarr;</a>
        </section>
    </main>

    <script>
        let currentLang = 'en';
        const langData = {
            en: { nav: ['Home', 'Games', 'Stats', 'Injuries', 'Lineups'], titles: { news: 'Latest News', stats: 'Season Leaders (Points)', inj: 'Injury Report', lin: 'Starting Lineups' }, btns: { refresh: 'Get Data', box: 'Box Score' }, desc: { inj: 'Official real-time injury data requires a paid license. Reliable sources:', lin: 'Confirmed starting lineups update 30 mins before tip-off.' }, links: { injEspn: 'View Official Injury Report on ESPN &rarr;', linRoto: 'View Real-Time Lineups on Rotowire &rarr;' } },
            tr: { nav: ['Ana Sayfa', 'Maçlar', 'İstatistikler', 'Sakatlıklar', 'Kadrolar'], titles: { news: 'Son Haberler', stats: 'Sezon Liderleri (Sayı)', inj: 'Sakatlık Raporu', lin: 'İlk 5\'ler' }, btns: { refresh: 'Verileri Getir', box: 'İstatistik' }, desc: { inj: 'Resmi anlık sakatlık verileri ücretli lisans gerektirir. Güvenilir kaynaklar:', lin: 'Kesinleşen ilk 5\'ler maçtan 30 dakika önce güncellenir.' }, links: { injEspn: 'ESPN Resmi Sakatlık Raporunu Görüntüle &rarr;', linRoto: 'Rotowire Anlık Kadroları Görüntüle &rarr;' } }
        };

        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date();
            document.getElementById('game-date').valueAsDate = today;
            
            // Nav buttons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    show(this.getAttribute('data-section'));
                });
            });
            
            // Modal close
            document.getElementById('close-modal').addEventListener('click', closeModal);
            document.getElementById('modal').addEventListener('click', function(e) {
                if (e.target.id === 'modal') closeModal();
            });
            
            // Language toggle
            document.getElementById('lang-toggle').addEventListener('click', toggleLang);
            
            // Refresh button
            document.getElementById('btn-refresh').addEventListener('click', fetchGames);
            
            // Initial data load
            fetchNews();
            fetchGames();
            fetchStats();
        });

        function show(id) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.querySelector('[data-section="' + id + '"]').classList.add('active');
        }

        function toggleLang() {
            currentLang = currentLang === 'en' ? 'tr' : 'en';
            const d = langData[currentLang];
            const btns = document.querySelectorAll('.nav-btn');
            btns.forEach((b, i) => b.innerText = d.nav[i]);
            document.getElementById('title-news').innerText = d.titles.news;
            document.getElementById('title-stats').innerText = d.titles.stats;
            document.getElementById('title-injuries').innerText = d.titles.inj;
            document.getElementById('title-lineups').innerText = d.titles.lin;
            document.getElementById('btn-refresh').innerText = d.btns.refresh;
            document.getElementById('desc-injuries').innerText = d.desc.inj;
            document.getElementById('desc-lineups').innerText = d.desc.lin;
            document.getElementById('link-injuries-espn').innerHTML = d.links.injEspn;
            document.getElementById('link-lineups-roto').innerHTML = d.links.linRoto;
        }

        function closeModal() {
            document.getElementById('modal').style.display = 'none';
        }

        // --- 1. NEWS (ESPN JSON) ---
        async function fetchNews() {
            const container = document.getElementById('news-container');
            container.innerHTML = '<div class="loader">Loading...</div>';
            try {
                const res = await fetch('/api/nba?type=news');
                const data = await res.json();
                if(!data.articles) throw new Error('No articles');
                container.innerHTML = '';
                data.articles.slice(0, 9).forEach(item => {
                    const img = item.images && item.images[0] ? item.images[0].url : 'https://via.placeholder.com/300x200?text=NBA';
                    const card = document.createElement('div');
                    card.className = 'news-card';
                    card.innerHTML = '<img src="' + img + '" class="news-img"><div class="news-body"><div class="news-title">' + item.headline + '</div></div>';
                    card.addEventListener('click', function() {
                        window.open(item.links.web.href, '_blank');
                    });
                    container.appendChild(card);
                });
            } catch (e) { 
                console.error('News error:', e);
                container.innerHTML = '<div class="loader">Unavailable.</div>'; 
            }
        }

        // --- 2. GAMES (ESPN) ---
        async function fetchGames() {
            const date = document.getElementById('game-date').value;
            const container = document.getElementById('games-container');
            container.innerHTML = '<div class="loader">Loading Scores...</div>';
            try {
                const res = await fetch('/api/nba?type=scoreboard&date=' + date);
                const data = await res.json();
                
                console.log('Games data:', data);
                
                container.innerHTML = '';
                if (!data.events || data.events.length === 0) { 
                    container.innerHTML = '<div class="loader">No games found.</div>'; 
                    return; 
                }
                
                data.events.forEach(e => {
                    const comp = e.competitions[0];
                    const h = comp.competitors.find(t => t.homeAway === 'home');
                    const a = comp.competitors.find(t => t.homeAway === 'away');
                    const btn = langData[currentLang].btns.box;
                    
                    const card = document.createElement('div');
                    card.className = 'game-card';
                    card.innerHTML = '<div class="game-main"><div class="team"><img src="' + a.team.logo + '"><div>' + a.team.abbreviation + '</div></div><div class="score">' + (a.score || 0) + ' - ' + (h.score || 0) + '</div><div class="team"><img src="' + h.team.logo + '"><div>' + h.team.abbreviation + '</div></div></div><div class="game-footer"><span style="float:left;color:#FDB927;font-weight:bold">' + e.status.type.detail + '</span><button class="box-btn" data-gameid="' + e.id + '" data-away="' + a.team.abbreviation + '" data-home="' + h.team.abbreviation + '">' + btn + '</button></div>';
                    
                    card.querySelector('.box-btn').addEventListener('click', function() {
                        openBox(this.getAttribute('data-gameid'), this.getAttribute('data-away'), this.getAttribute('data-home'));
                    });
                    
                    container.appendChild(card);
                });
            } catch (e) { 
                console.error('Games error:', e);
                container.innerHTML = '<div class="error-msg">Error loading games.</div>'; 
            }
        }

        // --- 3. BOX SCORE (ESPN STRUCTURE) ---
        async function openBox(id, tA, tB) {
            const modal = document.getElementById('modal');
            const body = document.getElementById('modal-body');
            modal.style.display = 'flex';
            document.getElementById('modal-title').innerText = tA + ' vs ' + tB;
            body.innerHTML = '<div class="loader">Loading...</div>';
            
            try {
                const res = await fetch('/api/nba?type=boxscore&gameId=' + id);
                const data = await res.json();
                
                console.log('Box score data:', data);
                
                if(!data.boxscore || !data.boxscore.players) { 
                    body.innerHTML = '<div class="error-msg">Box Score not ready yet. Try again during or after the game.</div>'; 
                    return; 
                }
                
                let html = '<div style="display:grid; grid-template-columns:1fr 1fr; gap:20px;">';
                
                data.boxscore.players.forEach(team => {
                    html += '<div><h4 style="color:#FDB927; border-bottom:1px solid #444; padding-bottom:5px;">' + team.team.displayName + '</h4><table class="bs-table"><thead><tr><th>Player</th><th>MIN</th><th>PTS</th><th>REB</th><th>AST</th></tr></thead><tbody>';
                    
                    team.statistics.forEach(p => {
                        const name = p.athlete && p.athlete.displayName ? p.athlete.displayName : 'Unknown';
                        const stats = p.stats || [];
                        
                        if(stats.length > 0 && stats[0] !== "0" && stats[0] !== "DNP") {
                            const min = stats[0] || '0';
                            const pts = stats[13] || '0';
                            const reb = stats[6] || '0';
                            const ast = stats[7] || '0';
                            
                            html += '<tr><td>' + name + '</td><td>' + min + '</td><td>' + pts + '</td><td>' + reb + '</td><td>' + ast + '</td></tr>';
                        }
                    });
                    
                    html += '</tbody></table></div>';
                });
                
                html += '</div>';
                body.innerHTML = html;
                
            } catch (e) { 
                console.error('Box score error:', e);
                body.innerHTML = '<div class="error-msg">Error loading box score. The game may not have started yet.</div>'; 
            }
        }

        // --- 4. STATS (Handle multiple API formats) ---
        async function fetchStats() {
            const container = document.getElementById('stats-container');
            container.innerHTML = '<div class="loader">Loading Leaders...</div>';
            
            try {
                const res = await fetch('/api/nba?type=stats');
                const data = await res.json();
                
                console.log('Raw stats data:', data);
                console.log('Data keys:', Object.keys(data));
                
                let players = [];
                
                // ESPN Leaders format (categories structure)
                if (data.categories && Array.isArray(data.categories)) {
                    console.log('Using ESPN categories structure');
                    const pointsCategory = data.categories.find(cat => 
                        cat.name === 'Points' || cat.displayName === 'Points' || cat.abbreviation === 'PTS'
                    ) || data.categories[0];
                    
                    if (pointsCategory && pointsCategory.leaders) {
                        players = pointsCategory.leaders.map(leader => {
                            const ath = leader.athlete || {};
                            return {
                                personId: ath.id,
                                firstName: ath.firstName || '',
                                lastName: ath.lastName || ath.displayName || ath.shortName,
                                points: parseFloat(leader.value || leader.displayValue || 0) * 
                                       (ath.statistics && ath.statistics.length > 0 ? parseFloat(ath.statistics[0].splits.categories[0].stats[0].value) : 25),
                                gamesPlayed: (ath.statistics && ath.statistics.length > 0 ? parseFloat(ath.statistics[0].splits.categories[0].stats[0].value) : 25),
                                teamSitesOnly: { teamTricode: ath.team ? ath.team.abbreviation : 'NBA' }
                            };
                        });
                    }
                }
                // NBA.com stats format (resultSets)
                else if (data.resultSets && Array.isArray(data.resultSets) && data.resultSets.length > 0) {
                    console.log('Using NBA.com resultSets structure');
                    const resultSet = data.resultSets[0];
                    const headers = resultSet.headers;
                    const rows = resultSet.rowSet;
                    
                    // Find column indices
                    const playerIdIdx = headers.indexOf('PLAYER_ID');
                    const playerNameIdx = headers.indexOf('PLAYER');
                    const teamIdx = headers.indexOf('TEAM_ABBREVIATION') || headers.indexOf('TEAM');
                    const ptsIdx = headers.indexOf('PTS');
                    const gpIdx = headers.indexOf('GP');
                    
                    players = rows.map(row => ({
                        personId: row[playerIdIdx],
                        firstName: '',
                        lastName: row[playerNameIdx],
                        points: parseFloat(row[ptsIdx]) * parseFloat(row[gpIdx]),
                        gamesPlayed: parseFloat(row[gpIdx]),
                        teamSitesOnly: { teamTricode: row[teamIdx] }
                    }));
                }
                // NBA CDN format
                else if (data.league && data.league.standard && data.league.standard.players) {
                    console.log('Using NBA CDN league.standard.players structure');
                    players = data.league.standard.players;
                }
                else {
                    console.error('Unknown structure. Full data:', data);
                    throw new Error('Unrecognized API response format');
                }
                
                if (!players || players.length === 0) {
                    throw new Error('No player data found in response');
                }
                
                console.log('Found ' + players.length + ' players');
                
                // Process and sort
                const processed = players
                    .filter(p => {
                        const games = p.gamesPlayed || p.GP || 0;
                        return games > 5;
                    })
                    .map(p => {
                        const games = p.gamesPlayed || p.GP || 1;
                        const points = p.points || p.PTS || 0;
                        
                        return {
                            id: p.personId || p.PLAYER_ID || Math.random().toString(),
                            name: (p.firstName && p.lastName) ? (p.firstName + ' ' + p.lastName) : (p.PLAYER_NAME || p.displayName || p.lastName || 'Unknown'),
                            team: (p.teamSitesOnly && p.teamSitesOnly.teamTricode) ? p.teamSitesOnly.teamTricode : (p.TEAM_ABBREVIATION || p.teamAbbreviation || 'NBA'),
                            ppg: (points / games).toFixed(1)
                        };
                    })
                    .filter(p => parseFloat(p.ppg) > 0)
                    .sort((a, b) => parseFloat(b.ppg) - parseFloat(a.ppg))
                    .slice(0, 10);

                if (processed.length === 0) {
                    throw new Error('No valid player stats after processing');
                }

                console.log('Processed players:', processed);

                let html = '<table class="stats-table"><thead><tr><th>#</th><th>Player</th><th>Team</th><th>PPG</th></tr></thead><tbody>';
                
                processed.forEach((p, i) => {
                    const img = 'https://cdn.nba.com/headshots/nba/latest/260x190/' + p.id + '.png';
                    html += '<tr><td><span class="rank">' + (i+1) + '</span></td><td><div class="player-info"><img src="' + img + '" class="player-head" onerror="this.src=\'https://via.placeholder.com/40\'"> ' + p.name + '</div></td><td>' + p.team + '</td><td><span class="stat-val">' + p.ppg + '</span></td></tr>';
                });
                
                container.innerHTML = html + '</tbody></table>';
                
            } catch(e) { 
                console.error('Stats error:', e);
                container.innerHTML = '<div class="error-msg">Stats temporarily unavailable.<br><small>Error: ' + e.message + '</small></div>'; 
            }
        }
    </script>
</body>
</html>
