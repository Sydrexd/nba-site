<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NBA Pro Analytics</title>
    <style>
        /* --- CSS (GÃœNCELLENDÄ°) --- */
        :root {
            --bg-color: #121212; --card-bg: #1e1e1e; --text-color: #e0e0e0;
            --accent-color: #C9082A; --secondary-color: #17408B; --gold: #FDB927;
        }
        body { margin: 0; font-family: 'Segoe UI', Roboto, sans-serif; background: var(--bg-color); color: var(--text-color); overflow-x: hidden; }

        /* HEADER & NAV */
        header { display: flex; justify-content: space-between; align-items: center; padding: 15px 30px; background: var(--card-bg); border-bottom: 3px solid var(--accent-color); position: sticky; top: 0; z-index: 100; box-shadow: 0 4px 20px rgba(0,0,0,0.5); }
        .header-logo { font-weight: 900; font-size: 1.4rem; color: #fff; letter-spacing: 1px; }
        .header-logo span { color: var(--accent-color); }
        nav button { background: none; border: none; color: #aaa; margin: 0 5px; font-size: 0.9rem; font-weight: 700; padding: 8px 10px; cursor: pointer; transition: 0.3s; }
        nav button.active { color: #fff; border-bottom: 3px solid var(--accent-color); }
        .lang-btn { background: #333; color: white; border: 1px solid #555; padding: 5px 12px; border-radius: 20px; cursor: pointer; font-size: 0.8rem; font-weight: bold; }

        /* CONTENT */
        main { padding: 20px; max-width: 1200px; margin: 0 auto; min-height: 80vh; }
        .section-content { display: none; animation: fadeIn 0.4s ease-out; }
        .section-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- DATE PICKER (YENÄ°) --- */
        .date-control { display: flex; justify-content: space-between; align-items: center; background: #252525; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #333; }
        .date-input { background: #111; border: 1px solid #444; color: white; padding: 8px 15px; border-radius: 5px; font-family: inherit; font-size: 1rem; }
        .refresh-btn { background: var(--secondary-color); color: white; border: none; padding: 8px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; }

        /* GAMES GRID */
        .games-grid { display: grid; gap: 20px; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); }
        .game-card { background: var(--card-bg); border-radius: 12px; overflow: hidden; border: 1px solid #333; display: flex; flex-direction: column; transition: transform 0.2s; }
        .game-card:hover { transform: translateY(-3px); border-color: var(--secondary-color); }
        
        .matchup-row { display: flex; height: 110px; align-items: center; position: relative; }
        .team-block { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 1; }
        .team-logo { width: 55px; height: 55px; object-fit: contain; margin-bottom: 5px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5)); }
        .team-score { font-size: 1.8rem; font-weight: 800; margin-top: 5px; color: #fff; }
        .team-record { font-size: 0.75rem; color: #888; margin-top: 2px; }
        
        .vs-block { display: flex; flex-direction: column; align-items: center; justify-content: center; width: 60px; }
        .game-status { font-size: 0.8rem; color: var(--gold); font-weight: bold; margin-bottom: 5px; text-align: center; }
        .vs-text { font-style: italic; font-weight: 900; color: #444; font-size: 1.2rem; }

        .card-footer { background: #252525; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; border-top: 1px solid #333; }
        .odds-badge { background: linear-gradient(45deg, #1e3c72, #2a5298); padding: 4px 10px; border-radius: 4px; font-size: 0.75rem; color: white; }
        .details-btn { background: transparent; border: 1px solid #555; color: #ccc; padding: 4px 12px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; transition: 0.3s; }
        .details-btn:hover { background: #fff; color: #000; }

        /* --- DETAILS MODAL (YENÄ°) --- */
        .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.85); z-index: 2000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-content { background: #1e1e1e; width: 90%; max-width: 900px; max-height: 90vh; border-radius: 12px; overflow-y: auto; box-shadow: 0 0 30px #000; border: 1px solid #444; }
        .modal-header { padding: 20px; background: #252525; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; }
        .modal-close { background: none; border: none; color: #fff; font-size: 1.5rem; cursor: pointer; }
        .modal-body { padding: 20px; }
        
        /* Box Score Table */
        .bs-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.9rem; }
        .bs-table th { background: #111; padding: 10px; text-align: left; color: #888; font-size: 0.8rem; position: sticky; top: 0; }
        .bs-table td { padding: 8px 10px; border-bottom: 1px solid #333; }
        .bs-row:hover { background: #2a2a2a; }
        .stat-high { color: var(--gold); font-weight: bold; }

        /* Haber KartlarÄ± */
        .news-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .news-card { background: var(--card-bg); border-radius: 10px; overflow: hidden; border: 1px solid #333; cursor: pointer; }
        .news-img { width: 100%; height: 180px; object-fit: cover; }
        .news-body { padding: 15px; }
        .news-title { font-weight: bold; margin-bottom: 5px; font-size: 1rem; }
    </style>
</head>
<body>

    <div id="details-modal" class="modal-overlay" onclick="closeModal('details-modal')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h3 id="modal-game-title" style="margin:0">Game Details</h3>
                <button class="modal-close" onclick="closeModal('details-modal')">Ã—</button>
            </div>
            <div class="modal-body" id="modal-game-body">
                <div style="text-align:center; padding:50px;">Loading Details...</div>
            </div>
        </div>
    </div>

    <header>
        <div class="header-logo">NBA <span>ANALYTICS</span></div>
        <nav>
            <button onclick="nav('home')" class="nav-btn active" id="btn-home">Home</button>
            <button onclick="nav('games')" class="nav-btn" id="btn-games">Games</button>
            <button onclick="nav('stats')" class="nav-btn" id="btn-stats">Stats</button>
        </nav>
        <button class="lang-btn" onclick="toggleLang()">EN / TR</button>
    </header>

    <main>
        <section id="home" class="section-content active">
            <h2 id="title-news">Latest News</h2>
            <div id="home-content" class="news-grid">Loading News...</div>
        </section>

        <section id="games" class="section-content">
            <div class="date-control">
                <div style="display:flex; align-items:center; gap:10px;">
                    <label style="font-weight:bold; color:#aaa;">Select Date:</label>
                    <input type="date" id="game-date" class="date-input" onchange="loadGames()">
                </div>
                <button class="refresh-btn" onclick="loadGames()">Refresh Data</button>
            </div>
            <div id="games-container" class="games-grid"></div>
        </section>

        <section id="stats" class="section-content">
            <h2 id="title-stats">Statistics</h2>
            <div style="margin-bottom:15px;">
                <button class="lang-btn" onclick="loadStats('PTS')">Points</button>
                <button class="lang-btn" onclick="loadStats('AST')">Assists</button>
                <button class="lang-btn" onclick="loadStats('REB')">Rebounds</button>
            </div>
            <div style="background:#1e1e1e; border-radius:8px; overflow:hidden;">
                <table style="width:100%; border-collapse:collapse;">
                    <tbody id="stats-body"></tbody>
                </table>
            </div>
        </section>
    </main>

    <script>
        // --- 1. AYARLAR ---
        const teamsDB = {
             'ATL': '#E03A3E', 'BOS': '#007A33', 'BKN': '#000000', 'CHA': '#1D1160', 'CHI': '#CE1141',
             'CLE': '#860038', 'DAL': '#00538C', 'DEN': '#0E2240', 'DET': '#C8102E', 'GSW': '#1D428A',
             'HOU': '#CE1141', 'IND': '#002D62', 'LAC': '#C8102E', 'LAL': '#552583', 'MEM': '#5D76A9',
             'MIA': '#98002E', 'MIL': '#00471B', 'MIN': '#0C2340', 'NOP': '#0C2340', 'NYK': '#F58426',
             'OKC': '#007AC1', 'ORL': '#0077C0', 'PHI': '#006BB6', 'PHX': '#1D1160', 'POR': '#E03A3E',
             'SAC': '#5A2D81', 'SAS': '#C4CED4', 'TOR': '#CE1141', 'UTA': '#002B5C', 'WAS': '#002B5C'
        };
        const imagePool = ["https://cdn.nba.com/manage/2023/10/victor-wembanyama-iso-cropped.jpg", "https://cdn.nba.com/manage/2023/11/lebron-james-iso-cropped.jpg", "https://cdn.nba.com/manage/2023/04/NBA-Playoff-Picture-2023.jpg", "https://cdn.nba.com/manage/2023/05/nikola-jokic-iso-cropped.jpg"];
        
        // BugÃ¼nÃ¼n tarihini inputa ayarla
        document.getElementById('game-date').valueAsDate = new Date();

        // --- 2. API FONKSÄ°YONLARI ---
        async function fetchAPI(endpoint, params = {}) {
            try {
                // Parametreleri URL'e ekle
                const query = new URLSearchParams({ ...params, type: endpoint, t: Date.now() }).toString();
                const res = await fetch(`/api/nba?${query}`);
                
                // News (XML) ise text dÃ¶n
                if(endpoint === 'news') return await res.text();
                
                return await res.json();
            } catch (e) {
                console.error("API Error:", e);
                return null;
            }
        }

        // --- 3. UI FONKSÄ°YONLARI ---
        function nav(id) {
            document.querySelectorAll('.section-content').forEach(e => e.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('btn-'+id).classList.add('active');
        }
        
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }

        // --- 4. MAÃ‡LARI YÃœKLE (Tarihli & DetaylÄ±) ---
        async function loadGames() {
            const date = document.getElementById('game-date').value;
            const container = document.getElementById('games-container');
            container.innerHTML = '<div style="text-align:center; padding:40px; color:#aaa">Loading Scores from NBA...</div>';

            const data = await fetchAPI('scoreboard', { date: date });
            
            // Veri yapÄ±sÄ± kontrolÃ¼ (NBA API yapÄ±sÄ± deÄŸiÅŸebiliyor)
            if (!data || !data.resultSets) {
                container.innerHTML = '<div style="text-align:center;">No games found for this date.</div>';
                return;
            }

            // GameHeader ve LineScore setlerini bul
            const headerSet = data.resultSets.find(s => s.name === 'GameHeader');
            const lineSet = data.resultSets.find(s => s.name === 'LineScore');
            
            if (!headerSet || headerSet.rowSet.length === 0) {
                container.innerHTML = '<div style="text-align:center;">No games scheduled.</div>';
                return;
            }

            container.innerHTML = '';

            // Her maÃ§ iÃ§in kart oluÅŸtur
            headerSet.rowSet.forEach(game => {
                const gameId = game[2]; // GAME_ID
                const status = game[4]; // GAME_STATUS_TEXT (Final, 7:00 pm vs)
                const homeId = game[6]; 
                const awayId = game[7];
                
                // SkorlarÄ± bul
                const homeLine = lineSet.rowSet.find(l => l[2] === gameId && l[3] === homeId);
                const awayLine = lineSet.rowSet.find(l => l[2] === gameId && l[3] === awayId);
                
                const homeScore = homeLine ? homeLine[22] : '-'; // PTS
                const awayScore = awayLine ? awayLine[22] : '-';
                const homeTri = homeLine ? homeLine[4] : 'HOM';
                const awayTri = awayLine ? awayLine[4] : 'AWY';
                const homeWin = homeLine ? homeLine[6] : 0; // W
                const homeLoss = homeLine ? homeLine[7] : 0; // L
                
                // Basit Odds AlgoritmasÄ± (Kazanma OranÄ±na GÃ¶re)
                let homeWinPct = (homeWin / (homeWin + homeLoss)) || 0.5;
                let prob = Math.round(homeWinPct * 100);
                // Ev sahibi avantajÄ± +5
                prob += 5; if(prob>99) prob=99;

                const logo = (id) => `https://cdn.nba.com/logos/nba/${id}/primary/L/logo.svg`;
                const color = (tri) => teamsDB[tri] || '#333';

                container.innerHTML += `
                    <div class="game-card">
                        <div class="matchup-row">
                            <div class="team-block" style="background:${color(awayTri)}99">
                                <img src="${logo(awayId)}" class="team-logo">
                                <div style="font-weight:bold; font-size:1.2rem">${awayTri}</div>
                                <div class="team-score">${awayScore}</div>
                            </div>
                            <div class="vs-block">
                                <div class="game-status">${status}</div>
                                <div class="vs-text">VS</div>
                            </div>
                            <div class="team-block" style="background:${color(homeTri)}99">
                                <img src="${logo(homeId)}" class="team-logo">
                                <div style="font-weight:bold; font-size:1.2rem">${homeTri}</div>
                                <div class="team-score">${homeScore}</div>
                            </div>
                        </div>
                        <div class="card-footer">
                            <div class="odds-badge">ðŸ”® Prediction: ${homeTri} %${prob}</div>
                            <button class="details-btn" onclick="openGameDetails('${gameId}', '${awayTri}', '${homeTri}')">View Box Score</button>
                        </div>
                    </div>
                `;
            });
        }

        // --- 5. DETAY MODALI (BOX SCORE) ---
        async function openGameDetails(gameId, away, home) {
            const modal = document.getElementById('details-modal');
            const title = document.getElementById('modal-game-title');
            const body = document.getElementById('modal-game-body');
            
            modal.style.display = 'flex';
            title.innerText = `${away} vs ${home} - Box Score`;
            body.innerHTML = '<div style="text-align:center; padding:30px;">Loading Official Data...</div>';

            const data = await fetchAPI('details', { gameId: gameId });
            
            if(!data || !data.resultSets) {
                body.innerHTML = 'Data not available yet.';
                return;
            }

            const players = data.resultSets[0].rowSet; // PlayerStats
            // 2 takÄ±mÄ± ayÄ±r
            const team1 = players.filter(p => p[2] === players[0][2]); // Ä°lk takÄ±m ID'si ile eÅŸleÅŸenler
            const team2 = players.filter(p => p[2] !== players[0][2]);

            // Tablo OluÅŸturucu Fonksiyon
            const createTable = (teamPlayers, teamName) => {
                let html = `<h4 style="margin:20px 0 10px 0; color:var(--gold)">${teamName} Stats</h4>`;
                html += `<table class="bs-table"><thead><tr><th>Player</th><th>MIN</th><th>PTS</th><th>REB</th><th>AST</th></tr></thead><tbody>`;
                
                teamPlayers.forEach(p => {
                    const name = p[5];
                    const min = p[8] || '-';
                    const pts = p[26];
                    const reb = p[20];
                    const ast = p[21];
                    // SayÄ±sÄ± yÃ¼ksekse renkli yap
                    const boldPts = pts > 20 ? 'stat-high' : '';

                    if(min) { // OynamayanlarÄ± gÃ¶sterme veya en alta at
                         html += `<tr class="bs-row">
                            <td>${name}</td>
                            <td>${min}</td>
                            <td class="${boldPts}">${pts}</td>
                            <td>${reb}</td>
                            <td>${ast}</td>
                         </tr>`;
                    }
                });
                html += `</tbody></table>`;
                return html;
            };

            body.innerHTML = `
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                    <div>${createTable(team1, team1[0][3] + ' ' + team1[0][4])}</div>
                    <div>${createTable(team2, team2[0][3] + ' ' + team2[0][4])}</div>
                </div>
            `;
        }

        // --- 6. HABERLER VE Ä°STATÄ°STÄ°KLER (ESKÄ° YAPININ Ä°YÄ°LEÅžTÄ°RÄ°LMÄ°Åž HALÄ°) ---
        async function init() {
            loadGames(); // VarsayÄ±lan olarak bugÃ¼nÃ¼ yÃ¼kle
            
            // Haberleri YÃ¼kle
            const xmlText = await fetchAPI('news');
            const parser = new DOMParser();
            const xml = parser.parseFromString(xmlText, "text/xml");
            const items = xml.getElementsByTagName('item');
            const newsCon = document.getElementById('home-content');
            newsCon.innerHTML = '';
            
            for(let i=0; i<Math.min(items.length, 6); i++) {
                const title = items[i].getElementsByTagName('title')[0].textContent;
                const link = items[i].getElementsByTagName('link')[0].textContent;
                const img = imagePool[i % imagePool.length];
                
                newsCon.innerHTML += `
                    <div class="news-card" onclick="window.open('${link}', '_blank')">
                        <img src="${img}" class="news-img">
                        <div class="news-body"><div class="news-title">${title}</div><div style="font-size:0.8rem; color:#888;">Read on ESPN</div></div>
                    </div>`;
            }

            loadStats('PTS');
        }

        async function loadStats(cat) {
             const tbody = document.getElementById('stats-body');
             tbody.innerHTML = '<tr><td style="padding:20px; text-align:center">Loading...</td></tr>';
             const data = await fetchAPI('stats', { category: cat });
             if(data && data.resultSet) {
                 tbody.innerHTML = '';
                 const rows = data.resultSet.rowSet.slice(0,5);
                 rows.forEach(r => {
                     tbody.innerHTML += `<tr><td style="padding:15px; border-bottom:1px solid #333; color:#fff;">${r[1]} <span style="color:#666">(${r[4]})</span></td><td style="text-align:right; padding:15px; color:var(--gold); font-weight:bold;">${r[23]}</td></tr>`;
                 });
             }
        }

        init();
    </script>
</body>
</html>
